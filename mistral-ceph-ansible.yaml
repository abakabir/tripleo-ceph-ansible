---
version: '2.0'

mistral-ceph-ansible:
  type: direct
  input: # i generated this w/ python, will make extensible later
    - monitor_secret
    #- openstack_keys
    #- ceph_conf_overrides
    - ip_version
    - ceph_stable
    - ceph_stable_key
    - raw_journal_devices
    - fsid
    - ceph_stable_repo
    - openstack_config
    - devices
    - public_network
    - ceph_stable_release
    - journal_collocation
    - cluster_network
    - raw_multi_journal
    - journal_size
    - mons
    - mdss
    - osds
    - rgws
    - rbd-mirrors
  tasks:
    ansible_hosts_update:
      action: std.ssh
      input:
        cmd: /home/stack/tripleo-ceph-ansible/ansible-inventory.sh
        host: localhost
        username: stack
        password: stack
      on-success: ansible_playbooks_copy
    ansible_playbooks_copy:
      action: std.ssh
      input:
        cmd: /usr/bin/cp -rf /usr/share/ceph-ansible /tmp/ ; chown -R mistral:mistral /tmp/ceph-ansible
        host: localhost
        username: stack
        password: stack
      on-success: mon_firewall
    mon_firewall: # this needs to be done in heat/puppet instead
      action: ansible
      input:
        hosts: 'mons'
        module: iptables
        module_args: 'chain=INPUT protocol=tcp destination_port=6789 jump=ACCEPT'
        remote_user: heat-admin
        become: true
        become_user: root
      publish:
        output: <% task(mon_firewall).result %>
      on-success: osd_firewall
    osd_firewall: # this needs to be done in heat/puppet instead
      action: ansible
      input:
        hosts: 'osds'
        module: iptables
        module_args: 'chain=INPUT protocol=tcp destination_port=6800:7300 jump=ACCEPT'
        remote_user: heat-admin
        become: true
        become_user: root
      publish:
        output: <% task(osd_firewall).result %>
      on-success: ceph_install
    ceph_install:
      action: ansible-playbook
      input:
        playbook: /tmp/ceph-ansible/site.yml.sample
        remote_user: heat-admin
        become: true
        become_user: root
        # skip_tags: package-install
        # i generated this w/ python, will make extensible later
        extra_vars: {"monitor_secret":"<% $.monitor_secret %>", "ip_version":"<% $.ip_version %>", "journal_size": <% $.journal_size %>, "ceph_stable": <% $.ceph_stable %>, "ceph_stable_key":"<% $.ceph_stable_key %>", "raw_journal_devices": <% $.raw_journal_devices %>, "fsid":"<% $.fsid %>", "ceph_stable_repo":"<% $.ceph_stable_repo %>", "openstack_config":"<% $.openstack_config %>", "devices":"<% $.devices %>", "public_network":"<% $.public_network %>", "ceph_stable_release":"<% $.ceph_stable_release %>", "journal_collocation": <% $.journal_collocation %>, "cluster_network":"<% $.cluster_network %>", "raw_multi_journal": <% $.raw_multi_journal %>, "monitor_interface":"br-ex"}
      publish:
        output: <% task(ceph_install).result %>
